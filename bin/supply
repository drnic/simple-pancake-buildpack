#!/bin/bash
# This script provides dependencies for an app

set -euo pipefail

export BUILD_DIR=$1
export CACHE_DIR=$2
export DEPS_DIR=$3
export DEPS_IDX=$4

export BUILDPACK_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`

echo "-----> Simple Pancake Buildpack version $(cat $BUILDPACK_DIR/VERSION)"

source $BUILDPACK_DIR/bin/helpers.sh

(
  fetch_dependency cf-pancake
  package=$(ls $CACHE_DIR/cf-pancake/*)

  mkdir -p /tmp/cf-pancake
  cd /tmp/cf-pancake
  tar xfJ $package

  mkdir -p $DEPS_DIR/$DEPS_IDX/bin
  cp cf-pancake* $DEPS_DIR/$DEPS_IDX/bin/cf-pancake
)

mkdir -p $DEPS_DIR/$DEPS_IDX/profile.d
cat > $DEPS_DIR/$DEPS_IDX/profile.d/finalize_pancake.sh <<BASH
#!/bin/bash

eval "\$(cf-pancake exports)"
BASH
