#!/bin/bash
# This script provides dependencies for an app

set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4

export BUILDPACK_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`

echo "-----> Running simple-pancake-buildpack bin/supply"
echo "       BUILD_DIR=$BUILD_DIR"
echo "       CACHE_DIR=$CACHE_DIR"
echo "       DEPS_DIR=$DEPS_DIR"
echo "       DEPS_IDX=$DEPS_IDX"
echo "       PATH: $PATH"
echo
echo "Current dir:"
ls -al
echo "BUILD_DIR:"
ls -al $BUILD_DIR/
echo "CACHE_DIR:"
ls -al $CACHE_DIR/
echo "DEPS_DIR:"
ls -al $DEPS_DIR/


yj_version=4.0.0
mkdir -p $CACHE_DIR/bin
curl -sSL -o $CACHE_DIR/bin/yt https://github.com/sclevine/yj/releases/download/v${yj_version}/yj-linux
chmod +x $CACHE_DIR/bin/yt
export PATH=$CACHE_DIR/bin:$PATH

package_name=cf-pancake
default_version=$(cat $BUILDPACK_DIR/manifest.yml | yt -y  | jq -r --arg name $package_name '.default_versions[] | select(.name == $name ).version')
default_download_uri=$(cat $BUILDPACK_DIR/manifest.yml | yt -y  | jq -r --arg name $package_name --arg version $default_version '.dependencies[] | select(.name == $name and .version == $version).uri')
default_download_sha256=$(cat $BUILDPACK_DIR/manifest.yml | yt -y  | jq -r --arg name $package_name --arg version $default_version '.dependencies[] | select(.name == $name and .version == $version).sha256')

echo "package_name: $package_name"
echo "default_version: $default_version"
echo "default_download_uri: $default_download_uri"
echo "default_download_sha256: $default_download_sha256"

(
  mkdir -p $CACHE_DIR/$package_name
  cd $CACHE_DIR/$package_name
  curl -sSLO $default_download_uri
  package=$(ls *)
  echo "$default_download_sha256  $package" | sha256sum -c

  (
    cd $BUILD_DIR
    tar tfJ $CACHE_DIR/$package_name/$package
  )
)

echo "BUILD_DIR:"
ls -al $BUILD_DIR/
